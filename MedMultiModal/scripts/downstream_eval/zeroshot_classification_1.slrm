#!/bin/bash

#SBATCH --job-name=multimodal_project
#SBATCH --partition=rtx6000,t4v1,t4v2
#SBATCH --mem-per-gpu=10GB
#SBATCH --time=6:00:00
#SBATCH --nodes=1
#SBATCH --gres=gpu:1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=4
#SBATCH --export=ALL
#SBATCH --output=../outputs/slurm-%j-%N.out
#SBATCH --open-mode=append

# load virtual environment
source ~/Documents/envs/mmm/bin/activate

cd ~/Documents/GitHub/Multimodal/MedMultiModal/src
git checkout main
export PYTHONPATH="."

# make a directory for results
mkdir $SLURM_JOBID

export NCCL_IB_DISABLE=1  # disable InfiniBand (the Vector cluster does not have it)
export NCCL_DEBUG=WARN
export NCCL_DEBUG_SUBSYS=WARN
export NCCL_ASYNC_ERROR_HANDLING=1 # set to 1 for NCCL backend
export CUDA_LAUNCH_BLOCKING=1
export TORCH_DISTRIBUTED_DEBUG=DETAIL
export HYDRA_FULL_ERROR=1
export OMP_NUM_THREADS=12

export MASTER_ADDR=$(hostname)
export MASTER_PORT=45678

nvidia-smi
echo SLURM_ARRAY_JOB_ID=${SLURM_ARRAY_JOB_ID}
echo SLURM_JOBID=${SLURM_JOBID}

# all zero-shot classification tasks, for a given model and pretrained weights
export MODEL=ViT-B-16
export PRETRAINED_WEIGHTS=/projects/multimodal/checkpoints/methods/Methods_Clip_LockText/checkpoints/epoch_7.pt
echo MODEL=${MODEL}
echo PRETRAINED_WEIGHTS=${PRETRAINED_WEIGHTS}

# “srun” executes the script <ntasks-per-node * nodes> times
# vindr_mammo
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset vindr_mammo \
        --split test \
        --dataset_root /projects/multimodal/datasets/vindr_mammo \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_vindr_mammo.json

# mimic-cxr
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset mimic_cxr_chexpert \
        --split test \
        --dataset_root /projects/multimodal/datasets/mimic_cxr/ \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_mimic_cxr_chexpert.json

# pad-ufes-20
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset pad_ufes_20 \
        --split test \
        --dataset_root /projects/multimodal/datasets/pad_ufes_20 \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_pad_ufes_20.json

# skin_cancer
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset skin_cancer \
        --split test \
        --dataset_root /projects/multimodal/datasets/skin_cancer \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_skin_cancer.json

# pcam
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset pcam \
        --split test \
        --dataset_root /projects/multimodal/datasets/pcam/ \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_pcam.json

# nck
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset nck \
        --split validation \
        --dataset_root /projects/multimodal/datasets/nct_crc_he_100k/ \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_nct_crc_he_100k.json

# lc25000_lung
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset lc25000_lung \
        --split test \
        --dataset_root /projects/multimodal/datasets/lc25000lung \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_lc25000lung.json

# lc25000_colon
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset lc25000_colon \
        --split test \
        --dataset_root /projects/multimodal/datasets/lc25000colon \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_lc25000colon.json

# bach
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset bach \
        --split test \
        --dataset_root /projects/multimodal/datasets/bach \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_bach.json

# sicap
srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python clip_benchmark/cli.py eval \
        --dataset sicap \
        --split test \
        --dataset_root /projects/multimodal/datasets/sicap \
        --task zeroshot_classification  \
        --model $MODEL \
        --pretrained $PRETRAINED_WEIGHTS \
        --output ${SLURM_JOBID}/result_sicap.json


# save all results in a table
cd ../scripts/downstream_eval
python zeroshot_classification.py ${SLURM_JOBID}