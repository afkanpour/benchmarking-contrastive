#!/bin/bash

#SBATCH --job-name=multimodal_project
#SBATCH --partition=rtx6000,t4v1,t4v2
#SBATCH --mem-per-gpu=16GB
#SBATCH --time=6:00:00
#SBATCH --nodes=1
#SBATCH --gres=gpu:1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --export=ALL
#SBATCH --output=../outputs/slurm-%j-%N.out
#SBATCH --open-mode=append

# load virtual environment
source ~/Documents/envs/mmm/bin/activate

cd ~/Documents/GitHub/Multimodal/MedMultiModal/src
git checkout main
export PYTHONPATH="."

# make a directory for results
mkdir $SLURM_JOBID

export NCCL_IB_DISABLE=1  # disable InfiniBand (the Vector cluster does not have it)
export NCCL_DEBUG=WARN
export NCCL_DEBUG_SUBSYS=WARN
export NCCL_ASYNC_ERROR_HANDLING=1 # set to 1 for NCCL backend
export CUDA_LAUNCH_BLOCKING=1
export TORCH_DISTRIBUTED_DEBUG=DETAIL
export HYDRA_FULL_ERROR=1
export OMP_NUM_THREADS=12

export MASTER_ADDR=$(hostname)
export MASTER_PORT=45678

nvidia-smi
echo SLURM_ARRAY_JOB_ID=${SLURM_ARRAY_JOB_ID}
echo SLURM_JOBID=${SLURM_JOBID}

# choose the model and pretrained weights
export MODEL=ViT-B-16
export PRETRAINED_WEIGHTS=/projects/multimodal/checkpoints/methods/Methods_Clip_TextUnlocked_2_ViT_B_16/checkpoints/epoch_3.pt
export FEWSHOT_LR=0.1
export FEWSHOT_EPOCHS=40
export BATCH_SIZE=64
echo MODEL=${MODEL}
echo PRETRAINED_WEIGHTS=${PRETRAINED_WEIGHTS}
echo FEWSHOT_LR=${FEWSHOT_LR}
echo FEWSHOT_EPOCHS=${FEWSHOT_EPOCHS}
echo BATCH_SIZE=${BATCH_SIZE}

# “srun” executes the script <ntasks-per-node * nodes> times
# medmnist_plus
for DATASET in chestmnist_plus pathmnist_plus dermamnist_plus octmnist_plus pneumoniamnist_plus retinamnist_plus breastmnist_plus bloodmnist_plus tissuemnist_plus organamnist_plus organcmnist_plus organsmnist_plus
do
    echo Running linear probing on $DATASET...
    srun --export=ALL -N $SLURM_JOB_NUM_NODES --cpu_bind=v --accel-bind=gn \
        python -u clip_benchmark/cli.py eval \
        --dataset $DATASET \
        --train_split train \
        --split test \
        --dataset_root /projects/multimodal/datasets/medmnist_plus \
        --task linear_probe \
        --model ${MODEL} \
        --pretrained ${PRETRAINED_WEIGHTS} \
        --output ${SLURM_JOBID}/result_$DATASET.json \
        --fewshot_lr ${FEWSHOT_LR} \
        --fewshot_epochs ${FEWSHOT_EPOCHS} \
        --batch_size ${BATCH_SIZE}
    echo Linear probing on $DATASET finished.
done

# save all results in a table
cd ../scripts/downstream_eval
python zeroshot_classification.py ${SLURM_JOBID}
